from crewai.tools import tool
import chardet
import ftfy
import re
import unicodedata

@tool
def clean_text_tool(text: str) -> str:
    """
    –û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ –æ—Ç –±–∏—Ç–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –∏ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º.
    
    üîπ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–¥–∏—Ä–æ–≤–∫—É —Å –ø–æ–º–æ—â—å—é `chardet`.
    üîπ –ü—Ä–æ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–∏—Ç—É—é –∫–æ–¥–∏—Ä–æ–≤–∫—É (`ftfy`).
    üîπ –£–±–∏—Ä–∞–µ—Ç –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç (`unicodedata`).
    
    üìå –í—Ö–æ–¥: —Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ (—Å—ã—Ä–æ–π).
    üìå –í—ã—Ö–æ–¥: –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    if not text:
        return "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

    # üè∑ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É
    detected_encoding = chardet.detect(text.encode())["encoding"]

    # üìå –ü—Ä–æ–±—É–µ–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å
    try:
        text = text.encode("latin1").decode(detected_encoding)
    except Exception:
        text = ftfy.fix_encoding(text)  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

    # üßπ –£–±–∏—Ä–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    text = unicodedata.normalize("NFKC", text)  # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∏–º–≤–æ–ª—ã
    text = re.sub(r"[^\w\s.,;!?¬´¬ª‚Äî()-]", "", text)  # –£–¥–∞–ª—è–µ–º –º—É—Å–æ—Ä–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    text = re.sub(r"\s+", " ", text).strip()  # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã

    return text